<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foreclosure Property Finder</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f26;
            --bg-card: #232a34;
            --accent: #10b981;
            --accent-hover: #059669;
            --accent-glow: rgba(16, 185, 129, 0.2);
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --border: #374151;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, var(--accent-glow) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                var(--bg-primary);
            z-index: -1;
        }

        /* Login Screen Styles */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 3rem;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-box h1 {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .login-box .subtitle {
            margin-bottom: 2rem;
        }

        .login-box input {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .login-box input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .login-box button {
            width: 100%;
            padding: 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .login-box button:hover {
            background: var(--accent-hover);
        }

        .login-error {
            color: var(--danger);
            margin-top: 1rem;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .main-content {
            display: none;
        }

        .main-content.visible {
            display: block;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            padding: 3rem 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        h1 {
            font-family: 'Playfair Display', Georgia, serif;
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .data-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border-radius: 2rem;
            font-size: 0.875rem;
            border: 1px solid var(--border);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            animation: pulse 2s infinite;
        }

        .status-dot.stale {
            background: var(--warning);
        }

        .status-dot.error {
            background: var(--danger);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sources-badge {
            display: inline-flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .source-tag {
            background: var(--bg-card);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .source-tag::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
        }

        /* API Key Section */
        .api-section {
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        .api-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .api-header h3 {
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .api-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .api-content {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .api-content.active {
            display: block;
        }

        .api-input-group {
            display: flex;
            gap: 1rem;
            align-items: end;
        }

        .api-input-group .form-field {
            flex: 1;
        }

        .api-input-group input {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            font-size: 0.85rem;
        }

        .api-status.connected {
            color: var(--accent);
        }

        .api-status.disconnected {
            color: var(--text-muted);
        }

        .api-help {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .api-help a {
            color: var(--accent);
            text-decoration: none;
        }

        .api-help a:hover {
            text-decoration: underline;
        }

        .api-help ol {
            margin: 0.5rem 0 0 1.25rem;
        }

        .api-help li {
            margin: 0.25rem 0;
        }

        /* Search Section */
        .search-section {
            background: var(--bg-card);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border);
        }

        .search-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .search-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .search-icon {
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .input-wrapper {
            position: relative;
        }

        .currency-symbol {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 1rem;
            font-weight: 600;
        }

        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 0.875rem 1rem;
            font-size: 1rem;
            font-family: inherit;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        input.with-symbol {
            padding-left: 2rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-glow);
        }

        input::placeholder {
            color: var(--text-muted);
        }

        select {
            cursor: pointer;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        .btn-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .btn-primary:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Results Section */
        .results-section {
            margin-top: 2rem;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .results-header h2 {
            font-size: 1.5rem;
        }

        .results-count {
            background: var(--accent);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        /* Property Cards */
        .property-grid {
            display: grid;
            gap: 1.5rem;
        }

        .property-card {
            background: var(--bg-card);
            border-radius: 1rem;
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.3s ease;
            display: grid;
            grid-template-columns: 280px 1fr;
        }

        @media (max-width: 900px) {
            .property-card {
                grid-template-columns: 1fr;
            }
        }

        .property-card:hover {
            border-color: var(--accent);
            transform: translateY(-4px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .property-image-section {
            position: relative;
            background: var(--bg-secondary);
            min-height: 180px;
        }

        .property-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .property-image-placeholder {
            width: 100%;
            height: 100%;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            padding: 1rem;
            text-align: center;
        }

        .property-image-placeholder svg {
            width: 40px;
            height: 40px;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        .property-image-placeholder span {
            font-size: 0.75rem;
        }

        .image-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0.5rem;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            display: flex;
            gap: 0.5rem;
        }

        .image-overlay a {
            flex: 1;
            padding: 0.4rem;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(4px);
            border-radius: 0.4rem;
            color: white;
            text-decoration: none;
            font-size: 0.7rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.2s ease;
        }

        .image-overlay a:hover {
            background: rgba(255,255,255,0.25);
        }

        .image-overlay a.zillow {
            background: rgba(0, 106, 255, 0.7);
        }

        .property-content {
            display: flex;
            flex-direction: column;
        }

        .property-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1rem 1.25rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            gap: 1rem;
        }

        .property-address {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .property-location {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .property-debt {
            text-align: right;
            flex-shrink: 0;
        }

        .debt-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .debt-amount {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent);
        }

        .property-body {
            padding: 1rem 1.25rem;
            flex: 1;
        }

        .property-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .detail-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .detail-value {
            color: var(--text-primary);
            word-break: break-word;
            font-size: 0.85rem;
        }

        .property-footer {
            padding: 0.75rem 1.25rem;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .source-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0.75rem;
            border-radius: 0.4rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .source-civilview {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .source-bid4assets {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .property-links {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
        }

        .property-links a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.35rem 0.75rem;
            border-radius: 0.4rem;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            background: var(--bg-card);
        }

        .property-links a:hover {
            color: var(--accent);
            background: var(--bg-primary);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 4rem 2rem;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Scrape Status Banner */
        .scrape-banner {
            background: var(--info);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            display: none;
            align-items: center;
            gap: 1rem;
        }

        .scrape-banner.active {
            display: flex;
        }

        .scrape-banner .spinner {
            width: 24px;
            height: 24px;
            border-width: 3px;
            margin: 0;
            border-color: rgba(255,255,255,0.3);
            border-top-color: white;
        }

        /* Export Buttons */
        .export-section {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-top: 4rem;
            border-top: 1px solid var(--border);
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .container {
                padding: 1rem;
            }

            .property-header {
                flex-direction: column;
                gap: 0.5rem;
            }

            .property-debt {
                text-align: left;
            }

            .property-footer {
                flex-direction: column;
                align-items: flex-start;
            }

            .property-links {
                margin-left: 0;
                width: 100%;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .btn-row {
                flex-direction: column;
            }

            .btn-row .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .property-card {
            animation: fadeIn 0.5s ease forwards;
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h1>üè† Foreclosure Finder</h1>
            <p class="subtitle">Enter password to access</p>
            <input type="password" id="loginPassword" placeholder="Password" onkeypress="if(event.key==='Enter')attemptLogin()">
            <button onclick="attemptLogin()">Login</button>
            <p id="loginError" class="login-error">Invalid password. Please try again.</p>
        </div>
    </div>

    <!-- Main Content (hidden until logged in) -->
    <div id="mainContent" class="main-content">
    
    <div class="container">
        <header>
            <h1>Foreclosure Property Finder</h1>
            <p class="subtitle">Live data from sheriff sale listings</p>
            <div class="data-status" id="dataStatus">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Checking data...</span>
            </div>
            <div class="sources-badge">
                <span class="source-tag">CivilView - Camden County, NJ</span>
                <span class="source-tag">Bid4Assets - Montgomery County, PA</span>
            </div>
        </header>

        <!-- Scrape Status Banner -->
        <div class="scrape-banner" id="scrapeBanner">
            <div class="spinner"></div>
            <span id="scrapeMessage">Scraping properties from county websites... This may take a few minutes.</span>
        </div>

        <!-- Google API Key Section -->
        <section class="api-section">
            <div class="api-header" onclick="toggleApiSection()">
                <h3>
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
                        <path d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z"/>
                    </svg>
                    Google Street View Setup (Optional)
                </h3>
                <button class="api-toggle">
                    <span id="apiToggleText">Show</span>
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="m6 9 6 6 6-6"/>
                    </svg>
                </button>
            </div>
            <div class="api-content" id="apiContent">
                <div class="api-input-group">
                    <div class="form-field">
                        <label for="googleApiKey">Google Maps API Key</label>
                        <input type="text" id="googleApiKey" placeholder="Enter your API key here...">
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="saveGoogleApiKey()">Save Key</button>
                </div>
                <div class="api-status" id="googleApiStatus">
                    <span class="status-dot"></span>
                    <span id="googleApiStatusText">No API key saved</span>
                </div>
                <div class="api-help">
                    <strong>How to get a free Google API key:</strong>
                    <ol>
                        <li>Go to <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a></li>
                        <li>Create a new project ‚Üí Enable "Street View Static API"</li>
                        <li>Go to Credentials ‚Üí Create API Key</li>
                        <li>Copy and paste here</li>
                    </ol>
                </div>
            </div>
        </section>

        <section class="search-section">
            <div class="search-header">
                <div class="search-icon">
                    <svg width="20" height="20" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                </div>
                <h2>Filter Properties</h2>
            </div>
            
            <div class="filters-grid">
                <div class="form-field">
                    <label for="maxDebt">Maximum Debt</label>
                    <div class="input-wrapper">
                        <span class="currency-symbol">$</span>
                        <input type="number" id="maxDebt" class="with-symbol" placeholder="e.g. 200000" min="0" step="1000">
                    </div>
                </div>
                <div class="form-field">
                    <label for="minDebt">Minimum Debt</label>
                    <div class="input-wrapper">
                        <span class="currency-symbol">$</span>
                        <input type="number" id="minDebt" class="with-symbol" placeholder="e.g. 50000" min="0" step="1000">
                    </div>
                </div>
                <div class="form-field">
                    <label for="countyFilter">County</label>
                    <select id="countyFilter">
                        <option value="">All Counties</option>
                        <option value="Camden">Camden County, NJ</option>
                        <option value="Montgomery">Montgomery County, PA</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="cityFilter">City</label>
                    <input type="text" id="cityFilter" placeholder="Filter by city...">
                </div>
            </div>

            <div class="btn-row">
                <button class="btn btn-primary" id="searchBtn" onclick="loadProperties()">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    Search Properties
                </button>
                <button class="btn btn-warning" onclick="triggerScrape()">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Refresh Data from Counties
                </button>
            </div>
        </section>

        <div class="stats-bar" id="statsBar">
            <div class="stat-card">
                <div class="stat-value" id="totalCount">-</div>
                <div class="stat-label">Total Properties</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="matchCount">-</div>
                <div class="stat-label">Matching Filters</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="lowestDebt">-</div>
                <div class="stat-label">Lowest Debt</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgDebt">-</div>
                <div class="stat-label">Average Debt</div>
            </div>
        </div>

        <section class="results-section" id="resultsSection">
            <div class="results-header">
                <h2>Properties <span class="results-count" id="resultsCount">0</span></h2>
                <div class="export-section">
                    <button class="btn btn-secondary btn-sm" onclick="exportCSV()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7,10 12,15 17,10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Export CSV
                    </button>
                </div>
            </div>
            <div class="property-grid" id="propertyGrid"></div>
        </section>

        <div class="loading" id="loadingState" style="display: none;">
            <div class="spinner"></div>
            <p>Loading properties...</p>
        </div>

        <div class="empty-state" id="emptyState" style="display: none;">
            <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <path d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"/>
            </svg>
            <h3>No Properties Found</h3>
            <p id="emptyMessage">Try adjusting your filters or refresh data from the counties.</p>
        </div>

        <footer>
            <p>Data scraped from official sheriff sale websites. Always verify with county offices.</p>
        </footer>
    </div>
    </div> <!-- End main-content -->

    <script>
        // Configuration
        const API_BASE = window.location.origin;
        let allProperties = [];
        let filteredProperties = [];
        let googleApiKey = localStorage.getItem('googleApiKey') || '';
        let authToken = sessionStorage.getItem('authToken') || '';
        let scrapeCheckInterval = null;

        // Login function
        async function attemptLogin() {
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            
            try {
                const response = await fetch(`${API_BASE}/api/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                if (response.ok) {
                    authToken = password;
                    sessionStorage.setItem('authToken', authToken);
                    showMainContent();
                    errorEl.classList.remove('show');
                    checkDataStatus();
                    loadProperties();
                } else {
                    errorEl.classList.add('show');
                    document.getElementById('loginPassword').value = '';
                }
            } catch (err) {
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.classList.add('show');
            }
        }

        // Show main content, hide login
        function showMainContent() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.add('visible');
        }

        // Show login, hide main content
        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainContent').classList.remove('visible');
            sessionStorage.removeItem('authToken');
            authToken = '';
        }

        // Check if existing token is still valid
        async function checkExistingAuth() {
            if (!authToken) {
                return false;
            }
            
            try {
                // Validate token with a quick API call
                const response = await authFetch(`${API_BASE}/api/stats`);
                if (response.ok) {
                    showMainContent();
                    return true;
                } else {
                    // Token invalid, clear it
                    showLogin();
                    return false;
                }
            } catch (err) {
                // Network error, but token exists - show main content anyway
                // It will handle errors when making actual requests
                showMainContent();
                return true;
            }
        }

        // Helper to add auth header to fetch requests
        function authFetch(url, options = {}) {
            options.headers = options.headers || {};
            options.headers['X-Auth-Token'] = authToken;
            return fetch(url, options);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            if (googleApiKey) {
                document.getElementById('googleApiKey').value = googleApiKey;
            }
            updateGoogleApiStatus();
            
            if (await checkExistingAuth()) {
                checkDataStatus();
                loadProperties();
            }
        });

        // Check data freshness
        async function checkDataStatus() {
            try {
                const response = await authFetch(`${API_BASE}/api/stats`);
                if (response.status === 401) {
                    showLogin();
                    return;
                }
                const data = await response.json();
                
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                if (data.lastUpdated) {
                    const lastUpdate = new Date(data.lastUpdated);
                    const hoursAgo = (Date.now() - lastUpdate) / (1000 * 60 * 60);
                    
                    if (hoursAgo < 24) {
                        statusDot.className = 'status-dot';
                        statusText.textContent = `Updated ${formatTimeAgo(lastUpdate)} ‚Ä¢ ${data.total} properties`;
                    } else {
                        statusDot.className = 'status-dot stale';
                        statusText.textContent = `Data is ${Math.floor(hoursAgo)} hours old ‚Ä¢ Click "Refresh Data" to update`;
                    }
                } else {
                    statusDot.className = 'status-dot error';
                    statusText.textContent = 'No data yet ‚Ä¢ Click "Refresh Data from Counties" to start';
                }
            } catch (err) {
                document.getElementById('statusDot').className = 'status-dot error';
                document.getElementById('statusText').textContent = 'Could not connect to server';
            }
        }

        function formatTimeAgo(date) {
            const seconds = Math.floor((Date.now() - date) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            return `${Math.floor(seconds / 86400)} days ago`;
        }

        // Load properties from API
        async function loadProperties() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            
            try {
                const params = new URLSearchParams();
                
                const maxDebt = document.getElementById('maxDebt').value;
                const minDebt = document.getElementById('minDebt').value;
                const county = document.getElementById('countyFilter').value;
                const city = document.getElementById('cityFilter').value;
                
                if (maxDebt) params.append('maxDebt', maxDebt);
                if (minDebt) params.append('minDebt', minDebt);
                if (county) params.append('county', county);
                if (city) params.append('city', city);
                
                const response = await authFetch(`${API_BASE}/api/properties?${params}`);
                if (response.status === 401) {
                    showLogin();
                    return;
                }
                const data = await response.json();
                
                allProperties = data.properties || [];
                filteredProperties = allProperties;
                
                document.getElementById('loadingState').style.display = 'none';
                
                // Update stats
                document.getElementById('totalCount').textContent = data.totalProperties || allProperties.length;
                document.getElementById('matchCount').textContent = filteredProperties.length;
                
                if (filteredProperties.length > 0) {
                    const debts = filteredProperties.map(p => p.debtAmount).filter(d => d > 0);
                    document.getElementById('lowestDebt').textContent = formatCurrency(Math.min(...debts));
                    document.getElementById('avgDebt').textContent = formatCurrency(debts.reduce((a, b) => a + b, 0) / debts.length);
                    
                    document.getElementById('resultsCount').textContent = filteredProperties.length;
                    displayProperties(filteredProperties);
                    document.getElementById('resultsSection').style.display = 'block';
                } else {
                    document.getElementById('lowestDebt').textContent = '-';
                    document.getElementById('avgDebt').textContent = '-';
                    document.getElementById('emptyState').style.display = 'block';
                }
                
            } catch (err) {
                console.error('Error loading properties:', err);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('emptyMessage').textContent = 'Error loading data. Make sure the server is running.';
            }
        }

        // Trigger a new scrape
        async function triggerScrape() {
            if (!confirm('This will scrape fresh data from the county websites. This may take 5-10 minutes. Continue?')) {
                return;
            }
            
            try {
                const response = await authFetch(`${API_BASE}/api/scrape`, { method: 'POST' });
                const data = await response.json();
                
                if (response.status === 429) {
                    alert('A scrape is already in progress. Please wait.');
                    return;
                }
                
                document.getElementById('scrapeBanner').classList.add('active');
                
                // Poll for completion
                scrapeCheckInterval = setInterval(async () => {
                    try {
                        const statusResponse = await authFetch(`${API_BASE}/api/scrape/status`);
                        const statusData = await statusResponse.json();
                        
                        if (!statusData.inProgress) {
                            clearInterval(scrapeCheckInterval);
                            document.getElementById('scrapeBanner').classList.remove('active');
                            
                            if (statusData.lastStatus?.status === 'completed') {
                                alert(`Scrape complete! Found ${statusData.lastStatus.propertiesFound} properties.`);
                                loadProperties();
                                checkDataStatus();
                            } else if (statusData.lastStatus?.status === 'error') {
                                alert(`Scrape error: ${statusData.lastStatus.error}`);
                            }
                        }
                    } catch (e) {
                        console.error('Error checking scrape status:', e);
                    }
                }, 5000);
                
            } catch (err) {
                console.error('Error triggering scrape:', err);
                alert('Failed to start scrape. Make sure the server is running.');
            }
        }

        // Display properties
        function displayProperties(properties) {
            const grid = document.getElementById('propertyGrid');
            grid.innerHTML = '';

            properties.forEach((prop, index) => {
                const card = document.createElement('div');
                card.className = 'property-card';
                card.style.animationDelay = `${Math.min(index * 0.03, 0.5)}s`;

                const sourceClass = prop.source === 'CivilView' ? 'source-civilview' : 'source-bid4assets';
                const streetViewUrl = getStreetViewUrl(prop.address, prop.city, prop.state, prop.zipCode);
                const zillowUrl = getZillowUrl(prop.address, prop.city, prop.state, prop.zipCode);
                const mapsUrl = getGoogleMapsUrl(prop.address, prop.city, prop.state, prop.zipCode);

                const imageSection = streetViewUrl 
                    ? `<img class="property-image" src="${streetViewUrl}" alt="Street View" onerror="this.parentElement.innerHTML='<div class=\\'property-image-placeholder\\'><span>No Street View</span></div>'">`
                    : `<div class="property-image-placeholder">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/>
                        </svg>
                        <span>Add Google API key for photos</span>
                    </div>`;

                card.innerHTML = `
                    <div class="property-image-section">
                        ${imageSection}
                        <div class="image-overlay">
                            <a href="${zillowUrl}" target="_blank" class="zillow">Zillow</a>
                            <a href="${mapsUrl}" target="_blank">Maps</a>
                        </div>
                    </div>
                    <div class="property-content">
                        <div class="property-header">
                            <div>
                                <div class="property-address">${prop.address || 'Address unavailable'}</div>
                                <div class="property-location">${prop.city || ''}, ${prop.state || ''} ${prop.zipCode || ''}</div>
                            </div>
                            <div class="property-debt">
                                <div class="debt-label">Debt Amount</div>
                                <div class="debt-amount">${prop.debtAmount ? formatCurrency(prop.debtAmount) : 'N/A'}</div>
                            </div>
                        </div>
                        <div class="property-body">
                            <div class="property-details">
                                <div class="detail-item">
                                    <span class="detail-label">Defendant</span>
                                    <span class="detail-value">${truncate(prop.defendant, 40) || 'N/A'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Sheriff #</span>
                                    <span class="detail-value">${prop.sheriffNumber || 'N/A'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Sale Date</span>
                                    <span class="detail-value">${prop.salesDate || 'N/A'}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Status</span>
                                    <span class="detail-value">${prop.status || 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="property-footer">
                            <span class="source-badge ${sourceClass}">${prop.source} - ${prop.county}</span>
                            <div class="property-links">
                                <a href="/goto.html?county=${encodeURIComponent(prop.county)}&propertyId=${getPropertyId(prop.detailUrl)}" target="_blank">View Source ‚Üó</a>
                            </div>
                        </div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function truncate(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function getStreetViewUrl(address, city, state, zip) {
            if (!googleApiKey || !address) return null;
            const fullAddress = `${address}, ${city || ''}, ${state || ''} ${zip || ''}`;
            return `https://maps.googleapis.com/maps/api/streetview?size=600x400&location=${encodeURIComponent(fullAddress)}&key=${googleApiKey}`;
        }

        function getZillowUrl(address, city, state, zip) {
            const searchQuery = `${address || ''} ${city || ''} ${state || ''} ${zip || ''}`.trim();
            return `https://www.zillow.com/homes/${encodeURIComponent(searchQuery)}_rb/`;
        }

        function getGoogleMapsUrl(address, city, state, zip) {
            const fullAddress = `${address || ''}, ${city || ''}, ${state || ''} ${zip || ''}`;
            return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddress)}`;
        }

        function getCountySearchUrl(county) {
            const countyUrls = {
                'Camden': 'https://salesweb.civilview.com/Sales/SalesSearch?countyId=1',
                'Montgomery': 'https://salesweb.civilview.com/Sales/SalesSearch?countyId=23'
            };
            return countyUrls[county] || 'https://salesweb.civilview.com/';
        }

        function getPropertyId(detailUrl) {
            if (!detailUrl) return '';
            const match = detailUrl.match(/PropertyId=(\d+)/i);
            return match ? match[1] : '';
        }

        // Google API key functions
        function toggleApiSection() {
            const content = document.getElementById('apiContent');
            const toggleText = document.getElementById('apiToggleText');
            content.classList.toggle('active');
            toggleText.textContent = content.classList.contains('active') ? 'Hide' : 'Show';
        }

        function saveGoogleApiKey() {
            googleApiKey = document.getElementById('googleApiKey').value.trim();
            if (googleApiKey) {
                localStorage.setItem('googleApiKey', googleApiKey);
            } else {
                localStorage.removeItem('googleApiKey');
            }
            updateGoogleApiStatus();
            loadProperties(); // Reload to show images
        }

        function updateGoogleApiStatus() {
            const statusEl = document.getElementById('googleApiStatus');
            const statusText = document.getElementById('googleApiStatusText');
            
            if (googleApiKey) {
                statusEl.className = 'api-status connected';
                statusText.textContent = 'API key saved - Street View images enabled';
            } else {
                statusEl.className = 'api-status disconnected';
                statusText.textContent = 'No API key - photos will not display';
            }
        }

        // Export
        function exportCSV() {
            // Create a temporary link with auth header workaround
            authFetch(`${API_BASE}/api/export/csv`)
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'foreclosures.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                })
                .catch(err => alert('Error exporting CSV'));
        }

        // Enter key support
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadProperties();
                }
            });
        });
    </script>
</body>
</html>
